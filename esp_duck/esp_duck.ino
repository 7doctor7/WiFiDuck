#include <Wire.h>

#define I2C_ADDR 0x31

#define BUFFER_SIZE 512
#define PACKETS_SIZE 32

#define RESPONSE_OK 0x00
#define RESPONSE_PROCESSING 0x01
#define RESPONSE_I2C_ERROR 0xFF

#define WAITING_TIME 25

int  bytesSent  = 0;
bool connection = false;

bool testConnection() {
    Wire.requestFrom(I2C_ADDR, 1);

    if (Wire.available()) {
        Wire.read();
        return true;
    } else {
        return false;
    }
}

uint8_t sendParseRequest() {
    Wire.requestFrom(I2C_ADDR, 1);

    if (Wire.available()) {
        return Wire.read();
    } else {
        Serial.println("Request error :(");
        connection = false;
        return RESPONSE_I2C_ERROR;
    }
}

void wait() {
    while (sendParseRequest() == RESPONSE_PROCESSING) {
        delay(WAITING_TIME);
        Serial.print('.');
    }

    bytesSent = 0;
}

void sendMessage(const char* msg) {
    if (!connection) return;

    wait();

    Serial.print("Sending message: ");
    Serial.print(msg);

    unsigned int msgLen = strlen(msg);
    int transmissions   = msgLen / PACKETS_SIZE;

    if (msgLen % PACKETS_SIZE != 0) ++transmissions;

    unsigned int j = 0;

    for (int i = 0; i < transmissions; i++) {
        if (bytesSent + PACKETS_SIZE > BUFFER_SIZE) wait();

        Wire.beginTransmission(0x31);

        for (unsigned int k = 0; k < PACKETS_SIZE && j < msgLen; k++) {
            Wire.write(msg[j]);
            ++j;
            ++bytesSent;
        }

        Wire.endTransmission();
    }

    sendParseRequest();
    Serial.println("Done");
}

void setup() {
    Serial.begin(115200);
    Serial.println();

    delay(2000);

    Wire.begin(5, 4); // join i2c bus (address optional for master)

    Serial.println("Started");

    if (testConnection()) {
        Serial.println("Connected!");

        connection = true;

        delay(2000);

        // sendMessage("DEFAULTDELAY 1000\n");
        // sendMessage("GUI r\n");
        // sendMessage("STRING notepad\n");
        // sendMessage("ENTER\n");

        sendMessage("DEFAULTDELAY 0\n");

        for (int i = 0; i<10; i++) {
            sendMessage("STRING 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890 01234567890\n");
            sendMessage("ENTER\n");
        }
    } else {
        Serial.println("Connection error");
    }
}

void loop() {}